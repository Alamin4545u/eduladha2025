<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Telegram Mini App</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://ad.gigapub.tech/script?id=4203"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --header-gradient-start: #3A6BE3; --header-gradient-end: #3682F8; --background-color: #f0f2f5; --card-bg: #ffffff;
            --text-color: #333; --text-color-light: #6c757d; --shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            --btn-red: #e74c3c; --btn-blue: #3498db; --btn-purple: #9b59b6; --btn-green: #2ecc71;
        }
        body { font-family: 'Poppins', sans-serif; margin: 0; padding: 0; background-color: var(--background-color); color: var(--text-color); user-select: none; -webkit-user-select: none; }
        .container { padding: 15px; padding-bottom: 80px; }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .page-title { font-size: 1.4em; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; }
        .back-btn { margin-right: 15px; cursor: pointer; font-size: 1.2em; }
        .header { background: linear-gradient(135deg, var(--header-gradient-start), var(--header-gradient-end)); color: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 25px rgba(58, 115, 230, 0.3); margin-bottom: 20px; }
        .profile-section { display: flex; align-items: center; margin-bottom: 20px; }
        #user-photo { width: 50px; height: 50px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.8); margin-right: 12px; background-color: #A0C4FF; }
        .user-details p { margin: 0; font-weight: 500; }
        #user-name { font-weight: 600; font-size: 1.1em; }
        #user-username { font-size: 0.9em; opacity: 0.8; }
        .balance-card { background: #3682F8; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .balance-card p { margin: 0; font-size: 1em; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }
        .balance-amount { font-size: 2.5em; font-weight: 700; display: flex; align-items: center; justify-content: center; margin-top: 5px; }
        .balance-amount .fa-coins { font-size: 0.8em; margin-right: 10px; }
        .task-btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .task-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; border: none; border-radius: 18px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: transform 0.2s, box-shadow 0.3s; }
        .task-btn i { font-size: 1.8em; margin-bottom: 12px; }
        .task-btn:active { transform: scale(0.95); }
        #start-task-btn { background-color: var(--btn-red); }
        #spin-earn-btn { background-color: var(--btn-blue); }
        #scratch-card-btn { background-color: var(--btn-purple); }
        #wallet-btn { background-color: var(--btn-green); }
        .task-list .task-item { background: var(--card-bg); padding: 20px; border-radius: 12px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); font-weight: 600; font-size: 1.1em; }
        .btn { background-color: var(--header-gradient-end); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-weight: 600; cursor: pointer; transition: background-color 0.3s; }
        .content-box { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: var(--shadow); margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Poppins'; }
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; }
        .status-Pending { color: orange; font-weight: 600; } .status-Approved { color: green; font-weight: 600; } .status-Rejected { color: red; font-weight: 600; }
        .referral-link-area { background: #eee; padding: 10px; border-radius: 8px; margin: 15px 0; word-wrap: break-word; }
        .notice-box { margin-top: 20px; padding: 15px; background: #eaf6ff; border-left: 5px solid var(--header-gradient-end); }
        .bottom-nav { display: flex; justify-content: space-around; align-items: center; position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--card-bg); box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; padding: 5px 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 8px 0; text-decoration: none; color: var(--text-color-light); transition: color 0.3s; cursor: pointer; }
        .nav-item i { font-size: 1.5em; margin-bottom: 4px; }
        .nav-item span { font-size: 0.8em; font-weight: 500; }
        .nav-item.active { color: var(--header-gradient-end); }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="profile-section">
                <img id="user-photo" alt="MM">
                <div class="user-details"><p id="user-name"></p><p id="user-username"></p></div>
            </div>
            <div class="balance-card">
                <p>Balance</p>
                <div class="balance-amount"><i class="fas fa-coins"></i><span id="balance"></span></div>
            </div>
        </header>
        <main id="home-page" class="page active">
            <div class="task-btn-group">
                <button id="start-task-btn" class="task-btn"><i class="fas fa-rocket"></i>Start Task</button>
                <button id="spin-earn-btn" class="task-btn"><i class="fas fa-sync-alt"></i>Spin & Earn</button>
                <button id="scratch-card-btn" class="task-btn"><i class="fas fa-palette"></i>Scratch Card</button>
                <button id="wallet-btn" class="task-btn"><i class="fas fa-wallet"></i>Wallet</button>
            </div>
        </main>
        <main id="task-list-page" class="page">
            <h2 class="page-title"><i class="fas fa-arrow-left back-btn"></i> Select a Task</h2>
            <div class="task-list"></div>
        </main>
        <main id="withdraw-page" class="page">
            <div class="content-box">
                <h2 class="page-title">Request Withdraw</h2>
                <div class="form-group"><label for="payment-method">Payment Method</label><select id="payment-method"></select></div>
                <div class="form-group"><label for="account-number">Account Number</label><input type="text" id="account-number" placeholder="e.g., 01700000000"></div>
                <div class="form-group"><label for="amount">Amount (TK)</label><input type="number" id="amount" placeholder="Enter amount"></div>
                <button id="submit-withdraw" class="btn" style="width: 100%;">Submit Request</button>
            </div>
             <div class="content-box">
                <h2 class="page-title">Withdraw History</h2>
                <table class="history-table"><thead><tr><th>Method</th><th>Amount</th><th>Status</th></tr></thead><tbody id="withdraw-history-body"></tbody></table>
            </div>
        </main>
        <main id="referral-page" class="page">
            <div class="content-box">
                <h2 class="page-title">Refer & Earn</h2>
                <div class="notice-box"><h4 style="margin-top:0;">Referral Policy</h4><p id="referral-notice"></p></div>
                <p style="margin-top:20px;">Share your referral link with friends and earn rewards!</p>
                <div class="referral-link-area" id="referral-link"></div>
                <button id="copy-referral-link" class="btn"><i class="fas fa-copy"></i> Copy Link</button>
            </div>
        </main>
        <main id="profile-page" class="page">
             <div class="content-box">
                <h2 class="page-title">My Profile</h2>
                <p><strong>Name:</strong> <span id="profile-name"></span></p>
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Balance:</strong> <span id="profile-balance"></span></p>
            </div>
        </main>
        <nav class="bottom-nav">
            <a class="nav-item active" data-page="home"><i class="fas fa-home"></i><span>Home</span></a>
            <a class="nav-item" data-page="withdraw"><i class="fas fa-money-bill-wave"></i><span>Wallet</span></a>
            <a class="nav-item" data-page="referral"><i class="fas fa-user-friends"></i><span>Referral</span></a>
            <a class="nav-item" data-page="profile"><i class="fas fa-user"></i><span>Profile</span></a>
        </nav>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const adminSettings = {
            botUsername: "Bkash_earn_free_TkBot", vpnCountries: ['US', 'GB', 'CA'],
            adsPerTask: 10, taskReward: 1.00,
            spinLimit: 20, spinReward: 1.00,
            scratchLimit: 20, scratchReward: 1.00,
            paymentMethods: [{ name: "Bkash", min: 50 }, { name: "Nagad", min: 50 }],
            referralBonus: 5.00, referralNotice: "প্রতিটি সফল রেফারের জন্য 5.00 টাকা বোনাস পান!"
        };

        let userData = {
            balance: 10.50,
            withdrawHistory: [{ method: 'Bkash', amount: 50, status: 'Approved' }]
        };
        
        const userInfo = tg.initDataUnsafe.user || {
            first_name: "MD ALAMIN", last_name: "MIA", username: "sagorikamim", id: 12345678, photo_url: null
        };
        
        let isTaskRunning = false;

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        function updateUI() {
            document.getElementById('balance').textContent = userData.balance.toFixed(2);
            const userName = `${userInfo.first_name} ${userInfo.last_name || ''}`.trim();
            document.getElementById('user-photo').src = userInfo.photo_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(userName)}&background=A0C4FF&color=fff&bold=true`;
            document.getElementById('user-name').textContent = userName;
            document.getElementById('user-username').textContent = `@${userInfo.username}`;
            document.getElementById('profile-name').textContent = userName;
            document.getElementById('profile-username').textContent = `@${userInfo.username}`;
            document.getElementById('profile-balance').textContent = `${userData.balance.toFixed(2)} TK`;
        }

        async function checkVPN() {
            tg.showPopup({ title: 'Checking Connection...', message: 'Please wait...' });
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                tg.closePopup();
                if (adminSettings.vpnCountries.includes(data.country_code)) return true;
                tg.showAlert(`Access Denied. Please connect to a VPN in ${adminSettings.vpnCountries.join(', ')}.`);
            } catch (error) {
                tg.closePopup();
                tg.showAlert("Could not verify your connection. Please try again.");
            }
            return false;
        }
        
        function generateTaskList() {
            const taskList = document.querySelector('.task-list');
            taskList.innerHTML = '';
            for (let i = 1; i <= 5; i++) {
                taskList.innerHTML += `<div class="task-item"><span>Task ${i}</span><button class="btn task-start-btn" data-task-id="${i}">Start</button></div>`;
            }
        }
        
        function startAdViewingFlow(taskName, adLimit, reward) {
            isTaskRunning = true;
            let adsWatched = 0;
            const watchAd = () => {
                if (adsWatched >= adLimit) {
                    userData.balance += reward;
                    updateUI();
                    tg.showAlert(`${taskName} completed! You earned ${reward.toFixed(2)} TK.`);
                    isTaskRunning = false;
                    return;
                }
                
                tg.showPopup({
                    title: `${taskName} (${adsWatched + 1}/${adLimit})`,
                    message: `Click 'Watch Ad' to proceed.`,
                    buttons: [{ id: 'watch', text: 'Watch Ad' }]
                }, (buttonId) => {
                    if (buttonId === 'watch') {
                        // --- Gigapub Ad Logic ---
                        if (typeof showGiga === 'function') {
                            showGiga()
                                .then(() => { adsWatched++; setTimeout(watchAd, 300); })
                                .catch(e => { tg.showAlert("Ad could not be loaded."); isTaskRunning = false; });
                        } else {
                            console.warn("showGiga not found. Simulating ad watch.");
                            adsWatched++; setTimeout(watchAd, 300);
                        }
                    } else { isTaskRunning = false; }
                });
            };
            watchAd();
        }

        // --- Event Listeners ---
        document.getElementById('start-task-btn').addEventListener('click', async () => {
            if (isTaskRunning) { tg.showAlert("Another task is already running."); return; }
            if (await checkVPN()) { generateTaskList(); showPage('task-list-page'); }
        });

        document.getElementById('spin-earn-btn').addEventListener('click', async () => {
            if (isTaskRunning) { tg.showAlert("Another task is already running."); return; }
            if (await checkVPN()) { startAdViewingFlow('Spin Task', adminSettings.spinLimit, adminSettings.spinReward); }
        });

        document.getElementById('scratch-card-btn').addEventListener('click', async () => {
            if (isTaskRunning) { tg.showAlert("Another task is already running."); return; }
            if (await checkVPN()) { startAdViewingFlow('Scratch Task', adminSettings.scratchLimit, adminSettings.scratchReward); }
        });

        document.getElementById('wallet-btn').addEventListener('click', () => {
            if (isTaskRunning) { tg.showAlert("Please complete your current task first."); return; }
            document.querySelector('.nav-item[data-page="withdraw"]').click();
        });

        document.querySelector('.task-list').addEventListener('click', e => {
            if (e.target.classList.contains('task-start-btn')) {
                if (isTaskRunning) { tg.showAlert("Another task is already running."); return; }
                startAdViewingFlow(`Task ${e.target.dataset.taskId}`, adminSettings.adsPerTask, adminSettings.taskReward);
            }
        });

        document.querySelector('.back-btn').addEventListener('click', () => {
             if (isTaskRunning) { tg.showAlert("Please complete your current task first."); return; }
             showPage('home-page');
        });
        
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                if (isTaskRunning) { tg.showAlert("Please complete your current task first."); return; }
                const pageId = item.dataset.page + '-page';
                showPage(pageId);
                document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
                item.classList.add('active');
                if (pageId === 'withdraw-page') loadWithdrawPage();
                if (pageId === 'referral-page') loadReferralPage();
            });
        });

        function loadWithdrawPage() {
            const methodSelect = document.getElementById('payment-method');
            methodSelect.innerHTML = '';
            adminSettings.paymentMethods.forEach(method => methodSelect.innerHTML += `<option value="${method.name}">${method.name} (Min: ${method.min} TK)</option>`);
            const historyBody = document.getElementById('withdraw-history-body');
            historyBody.innerHTML = '';
            userData.withdrawHistory.forEach(item => historyBody.innerHTML += `<tr><td>${item.method}</td><td>${item.amount.toFixed(2)}</td><td><span class="status-${item.status}">${item.status}</span></td></tr>`);
        }
        
        document.getElementById('submit-withdraw').addEventListener('click', () => tg.showAlert("Withdrawal request submitted (simulated)."));
        
        function loadReferralPage() {
            document.getElementById('referral-link').textContent = `https://t.me/${adminSettings.botUsername}?start=${userInfo.id}`;
            document.getElementById('referral-notice').textContent = adminSettings.referralNotice;
        }

        document.getElementById('copy-referral-link').addEventListener('click', () => {
            navigator.clipboard.writeText(document.getElementById('referral-link').textContent).then(() => tg.showAlert('Referral link copied!'));
        });

        updateUI();
    });
    </script>
</body>
</html>
