<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GigaEarn TWA</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Tabler Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">

    <!-- ðŸ”¥ REQUIRED SCRIPTS ðŸ”¥ -->
    <!-- 1. Telegram WebApp -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- 2. Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- 3. Gigapub Ad Script -->
    <script src="https://ad.gigapub.tech/script?id=4413" onerror="App.scriptError()"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.08);
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.5);
            --secondary: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --font-main: 'Outfit', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: var(--font-main);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, #1e1b4b 0%, #0f172a 70%);
        }

        /* Utilities */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-in; }

        /* Splash Screen */
        #splash-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: var(--bg-dark);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        .logo-pulse {
            font-size: 4rem; color: var(--primary);
            filter: drop-shadow(0 0 15px var(--primary-glow));
            animation: pulse 1.5s infinite;
            margin-bottom: 20px;
        }

        /* Loading Spinner */
        .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(255,255,255,0.3); 
            border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite;
        }

        /* Layout */
        #app-container { height: 100%; display: flex; flex-direction: column; }

        header {
            padding: 20px 25px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
        }
        .user-info h3 { font-size: 1.1rem; }
        .user-info span { font-size: 0.8rem; color: var(--text-muted); }
        .balance-badge {
            background: rgba(255, 215, 0, 0.1); color: #fbbf24;
            padding: 8px 15px; border-radius: 25px; border: 1px solid rgba(251, 191, 36, 0.3);
            font-weight: 700; display: flex; align-items: center; gap: 6px;
        }

        main { flex: 1; overflow-y: auto; padding: 25px; padding-bottom: 100px; }
        
        section { display: none; }
        section.active-view { display: block; animation: slideUp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        /* Cards */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 25px; margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Coming Soon Overlay */
        .coming-soon-overlay {
            position: absolute; inset: 0; background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(5px); border-radius: 24px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 10;
        }
        .cs-badge {
            background: var(--primary); color: white; padding: 5px 15px;
            border-radius: 20px; font-size: 0.8rem; font-weight: bold; margin-bottom: 10px;
        }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-box {
            background: rgba(255,255,255,0.03); border-radius: 18px; padding: 15px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .stat-box i { font-size: 1.5rem; margin-bottom: 5px; }
        .stat-box.blue i { color: #60a5fa; }
        .stat-box.purple i { color: #c084fc; }
        .stat-box h2 { font-size: 1.5rem; margin-top: 5px; }

        /* Engine Panel */
        .engine-status { 
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; 
            font-weight: 600; font-size: 0.9rem;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #64748b; transition: 0.3s; }
        .dot.active { background: #22c55e; box-shadow: 0 0 10px #22c55e; }

        /* Circular Timer */
        .timer-wrapper { position: relative; width: 160px; height: 160px; margin: 0 auto 30px; }
        .timer-svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 10; }
        .circle-progress { 
            fill: none; stroke: var(--primary); stroke-width: 10; stroke-linecap: round;
            stroke-dasharray: 440; stroke-dashoffset: 440; transition: stroke-dashoffset 1s linear;
        }
        .timer-content { 
            position: absolute; inset: 0; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
        }
        .timer-content h1 { font-size: 3.5rem; line-height: 1; }
        .timer-content span { font-size: 0.9rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }

        /* Console Log */
        .console-log {
            width: 100%; height: 80px; background: rgba(0,0,0,0.5); border-radius: 12px;
            padding: 10px; font-family: 'Courier New', monospace; font-size: 0.75rem;
            overflow-y: auto; margin-top: 20px; border: 1px solid var(--glass-border);
        }
        .log-line { margin-bottom: 4px; display: block; }
        .log-success { color: #4ade80; }
        .log-error { color: #f87171; }
        .log-info { color: #94a3b8; }

        /* Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 80px;
            background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
            border-top: 1px solid var(--glass-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 100; padding-bottom: 10px;
        }
        .nav-btn { color: #64748b; font-size: 1.6rem; padding: 10px; position: relative; transition: 0.3s; }
        .nav-btn.active { color: var(--text-main); }
        .play-btn-wrapper { transform: translateY(-25px); }
        .play-btn {
            width: 65px; height: 65px; background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; color: white; box-shadow: 0 10px 25px var(--primary-glow);
            border: 5px solid var(--bg-dark); cursor: pointer;
        }

        /* Buttons */
        .btn-primary {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; font-weight: 700; cursor: pointer; font-size: 1rem;
            box-shadow: 0 4px 20px var(--primary-glow); transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-danger {
            width: 100%; padding: 16px; border: none; border-radius: 16px;
            background: linear-gradient(135deg, #ef4444, #b91c1c);
            color: white; font-weight: 700; cursor: pointer; font-size: 1rem;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:active { transform: scale(0.96); }

        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <!-- Splash Screen -->
    <div id="splash-screen">
        <div class="logo-pulse">
            <i class="ti ti-bolt"></i>
        </div>
        <h2>GigaEarn Bot</h2>
        <div style="margin-top: 15px; display: flex; align-items: center; gap: 10px; color: var(--text-muted);">
            <div class="spinner"></div>
            <span>Connecting Supabase...</span>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app-container" class="hidden">
        
        <header>
            <div class="user-info">
                <span>Hello,</span>
                <h3 id="display-username">Loading...</h3>
            </div>
            <div class="balance-badge">
                <i class="ti ti-coin"></i> <span id="header-balance">0</span>
            </div>
        </header>

        <main>
            <!-- 1. HOME DASHBOARD -->
            <section id="view-home" class="active-view">
                <div class="stats-grid">
                    <div class="stat-box blue">
                        <i class="ti ti-eye"></i>
                        <span>Impressions</span>
                        <h2 id="total-impressions">0</h2>
                    </div>
                    <div class="stat-box purple">
                        <i class="ti ti-diamond"></i>
                        <span>Points</span>
                        <h2 id="total-points">0</h2>
                    </div>
                </div>

                <div class="glass-card" style="margin-top: 20px;">
                    <h3>Telegram User</h3>
                    <div style="margin-top: 15px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px;">
                        <span style="color: var(--text-muted);">Status</span>
                        <span style="color: var(--success);">Connected</span>
                    </div>
                    <div style="margin-top: 10px; display: flex; justify-content: space-between;">
                        <span style="color: var(--text-muted);">TG ID</span>
                        <span id="user-uid" style="font-family: monospace;">---</span>
                    </div>
                </div>

                <button class="btn-primary" onclick="App.navTo('earn')">
                    <i class="ti ti-player-play"></i> Start Earning
                </button>
            </section>

            <!-- 2. EARNING PANEL -->
            <section id="view-earn">
                <div class="glass-card" style="text-align: center;">
                    <div class="engine-status">
                        <div id="status-dot" class="dot"></div>
                        <span id="engine-state-text">Engine Stopped</span>
                    </div>

                    <div class="timer-wrapper">
                        <svg class="timer-svg" viewBox="0 0 160 160">
                            <circle class="circle-bg" cx="80" cy="80" r="70"></circle>
                            <circle id="progress-ring" class="circle-progress" cx="80" cy="80" r="70"></circle>
                        </svg>
                        <div class="timer-content">
                            <h1 id="countdown-text">10</h1>
                            <span>Seconds</span>
                        </div>
                    </div>

                    <button id="btn-start" class="btn-primary" onclick="Engine.start()">
                        <i class="ti ti-bolt"></i> Start Auto
                    </button>
                    
                    <button id="btn-stop" class="btn-danger hidden" onclick="Engine.stop()">
                        <i class="ti ti-player-pause"></i> Stop
                    </button>

                    <div class="console-log" id="log-container">
                        <span class="log-line log-info">> Ready to earn points...</span>
                    </div>
                </div>
            </section>

            <!-- 3. WALLET / WITHDRAW (COMING SOON) -->
            <section id="view-wallet">
                <div class="glass-card" style="text-align: center; height: 300px; display: flex; align-items: center; justify-content: center;">
                    <!-- Overlay -->
                    <div class="coming-soon-overlay">
                        <div class="cs-badge">UPDATE</div>
                        <h2>Coming Soon</h2>
                        <p style="color: var(--text-muted); margin-top: 5px;">Wallet features are under development.</p>
                    </div>
                    
                    <!-- Blurry Background Content -->
                    <div style="filter: blur(5px); opacity: 0.3; width: 100%;">
                        <h2>Withdraw</h2>
                        <input type="text" placeholder="Wallet Address" disabled>
                        <button class="btn-primary">Submit</button>
                    </div>
                </div>
            </section>
        </main>

        <!-- Navigation -->
        <nav class="bottom-nav">
            <div class="nav-btn active" onclick="App.navTo('home', this)">
                <i class="ti ti-home"></i>
            </div>
            <div class="play-btn-wrapper" onclick="App.navTo('earn')">
                <div class="play-btn">
                    <i class="ti ti-bolt"></i>
                </div>
            </div>
            <div class="nav-btn" onclick="App.navTo('wallet', this)">
                <i class="ti ti-wallet"></i>
            </div>
        </nav>
    </div>

    <!-- LOGIC -->
    <script>
        // ==========================================
        // âš™ï¸ CONFIGURATION (Replace Keys Here!)
        // ==========================================
        const CONFIG = {
            supabaseUrl: 'https://uqyhgzhesvlvclszkkkm.supabase.co', // ðŸ‘ˆ à¦†à¦ªà¦¨à¦¾à¦° URL à¦¦à¦¿à¦¨
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxeWhnemhlc3ZsdmNsc3pra2ttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIxNzYsImV4cCI6MjA3OTY4ODE3Nn0.X9sZ8V6fOcMbXWnbkMonT-gE1xH-TEDur3Aa7aEGjDc', // ðŸ‘ˆ à¦†à¦ªà¦¨à¦¾à¦° Anon Key à¦¦à¦¿à¦¨
            cycleTime: 10,
            pointsPerAd: 100
        };

        // Initialize Supabase Client
        const supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseKey);

        // --- User Data Manager (Supabase Linked) ---
        const Data = {
            user: { 
                telegram_id: null, 
                username: 'Guest', 
                points: 0,
                impressions: 0
            },

            async init() {
                // 1. Detect Telegram User
                const tg = window.Telegram.WebApp;
                tg.expand(); // Fullscreen

                let tgId, tgName;

                if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
                    // Running inside Telegram
                    tgId = tg.initDataUnsafe.user.id.toString();
                    tgName = tg.initDataUnsafe.user.first_name;
                } else {
                    // Browser Testing (Fallback)
                    tgId = localStorage.getItem('test_tg_id') || 'test_user_' + Math.floor(Math.random() * 1000);
                    localStorage.setItem('test_tg_id', tgId);
                    tgName = "Test User";
                }

                this.user.telegram_id = tgId;
                this.user.username = tgName;

                // 2. Sync with Supabase
                await this.syncWithDb();
                App.updateUI();
            },

            async syncWithDb() {
                try {
                    // Check if user exists
                    let { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .eq('telegram_id', this.user.telegram_id)
                        .single();

                    if (error && error.code !== 'PGRST116') {
                        // Real Error
                        console.error('DB Error:', error);
                    } else if (!data) {
                        // User New -> Insert
                        const { error: insertError } = await supabase
                            .from('users')
                            .insert([
                                { 
                                    telegram_id: this.user.telegram_id, 
                                    username: this.user.username,
                                    points: 0
                                }
                            ]);
                        if(insertError) console.error(insertError);
                    } else {
                        // User Exists -> Load Data
                        this.user.points = data.points;
                        this.user.impressions = 0; // Session based impression count
                    }
                } catch (err) {
                    App.log("DB Connection Failed", "error");
                }
            },

            async addPoints(amount) {
                this.user.points += amount;
                this.user.impressions++;
                App.updateUI();

                // Update Database Background
                const { error } = await supabase
                    .from('users')
                    .update({ points: this.user.points })
                    .eq('telegram_id', this.user.telegram_id);
                
                if(error) App.log("Save Failed!", "error");
            }
        };

        // --- Engine Logic ---
        const Engine = {
            active: false,
            timer: null,
            timeLeft: CONFIG.cycleTime,
            
            start() {
                if(this.active) return;
                
                // Script Check
                if(typeof window.showGiga === 'undefined') {
                    App.log("âš ï¸ Ad script blocked/missing.", "error");
                    alert("Disable AdBlock to continue.");
                }

                this.active = true;
                this.toggleBtn(true);
                App.log("ðŸš€ Engine Started. Loading Ads...", "success");
                this.loop();
            },

            stop() {
                this.active = false;
                clearInterval(this.timer);
                this.timeLeft = CONFIG.cycleTime;
                this.updateCircle(0);
                document.getElementById('countdown-text').innerText = CONFIG.cycleTime;
                this.toggleBtn(false);
                App.log("ðŸ›‘ Engine Stopped.", "info");
            },

            toggleBtn(running) {
                document.getElementById('btn-start').classList.toggle('hidden', running);
                document.getElementById('btn-stop').classList.toggle('hidden', !running);
                document.getElementById('status-dot').classList.toggle('active', running);
                document.getElementById('engine-state-text').innerText = running ? "Engine Running" : "Engine Stopped";
                document.getElementById('engine-state-text').style.color = running ? "#22c55e" : "#94a3b8";
            },

            loop() {
                this.timeLeft = CONFIG.cycleTime;
                
                this.timer = setInterval(() => {
                    if(!this.active) return;

                    this.timeLeft--;
                    const percent = ((CONFIG.cycleTime - this.timeLeft) / CONFIG.cycleTime) * 100;
                    this.updateCircle(percent);
                    document.getElementById('countdown-text').innerText = this.timeLeft;

                    if(this.timeLeft <= 0) {
                        this.triggerAd();
                        this.timeLeft = CONFIG.cycleTime;
                    }
                }, 1000);
            },

            async triggerAd() {
                App.log("ðŸ”„ Loading Ad...", "info");
                
                try {
                    if (typeof window.showGiga === 'function') {
                        // Gigapub Call
                        window.showGiga().then(() => {
                            this.success();
                        }).catch((err) => {
                            App.log("âš ï¸ No Ad Fill. Retrying...", "error");
                        });
                    } else {
                        // Testing fallback
                        setTimeout(() => this.success(), 1000); 
                    }
                } catch (e) { console.error(e); }
            },

            success() {
                Data.addPoints(CONFIG.pointsPerAd);
                App.log(`âœ… Ad Watched! +${CONFIG.pointsPerAd} Points`, "success");
            },

            updateCircle(percent) {
                const circle = document.getElementById('progress-ring');
                const radius = circle.r.baseVal.value;
                const circumference = radius * 2 * Math.PI;
                const offset = circumference - (percent / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        };

        // --- App Controller ---
        const App = {
            async init() {
                // Start Supabase & User Load
                await Data.init();

                // Remove Splash
                setTimeout(() => {
                    document.getElementById('splash-screen').style.opacity = 0;
                    setTimeout(() => {
                        document.getElementById('splash-screen').classList.add('hidden');
                        document.getElementById('app-container').classList.remove('hidden');
                    }, 500);
                }, 1500);
            },

            updateUI() {
                document.getElementById('display-username').innerText = Data.user.username;
                document.getElementById('user-uid').innerText = Data.user.telegram_id;
                document.getElementById('total-points').innerText = Data.user.points;
                document.getElementById('header-balance').innerText = Data.user.points;
                document.getElementById('total-impressions').innerText = Data.user.impressions;
            },

            navTo(viewId, btnElement) {
                document.querySelectorAll('section').forEach(el => el.classList.remove('active-view'));
                document.getElementById('view-' + viewId).classList.add('active-view');

                if(btnElement) {
                    document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
                    btnElement.classList.add('active');
                }
            },

            log(msg, type) {
                const container = document.getElementById('log-container');
                const p = document.createElement('span');
                const time = new Date().toLocaleTimeString().split(' ')[0];
                p.className = `log-line log-${type}`;
                p.innerText = `[${time}] ${msg}`;
                container.prepend(p);
            },
            
            scriptError() {
                console.log("Gigapub script failed to load");
            }
        };

        // Start App
        window.onload = () => App.init();

    </script>
</body>
</html>
