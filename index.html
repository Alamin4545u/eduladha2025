<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Premium Rewards</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <!-- Monetag SDK (Ad Network) -->
    <script src='//libtl.com/sdk.js' data-zone='10197154' data-sdk='show_10197154'></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #0f0f0f; color: #ffffff; overflow: hidden; height: 100vh; display: flex; flex-direction: column; -webkit-tap-highlight-color: transparent; }
        .gold-gradient { background: linear-gradient(135deg, #FFD700 0%, #FDB931 50%, #d4af37 100%); }
        .gold-text { background: linear-gradient(to right, #FFD700, #FDB931); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .glass-panel { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 215, 0, 0.1); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); }
        .nav-item { flex: 1; }
        .nav-item.active { color: #FFD700; }
        .nav-item.active i { transform: translateY(-5px); text-shadow: 0 0 10px rgba(255, 215, 0, 0.5); }
        .loader { border: 4px solid #333; border-top: 4px solid #FFD700; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        div:where(.swal2-container) div:where(.swal2-popup) { background: #1a1a1a !important; border: 1px solid #FFD700; color: white; }
        #main-app::-webkit-scrollbar { display: none; } #main-app { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-[#0f0f0f]">
        <div class="loader"></div>
        <h2 class="text-xl font-bold gold-text tracking-widest mt-4">PREMIUM REWARDS</h2>
        <p class="text-xs text-gray-400 mt-2">Loading your account...</p>
    </div>

    <header class="glass-panel border-b-0 rounded-b-3xl p-4 z-40 shrink-0">
        <div class="flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img id="user-photo" src="https://ui-avatars.com/api/?name=U&background=random" class="w-10 h-10 rounded-full border-2 border-[#FFD700] object-cover">
                <div>
                    <h3 id="user-name" class="font-bold text-md leading-tight">Loading...</h3>
                    <span class="text-[10px] text-gray-400">Premium Member</span>
                </div>
            </div>
            <div class="text-right">
                <p class="text-[10px] text-gray-400">Balance</p>
                <div class="flex items-center gap-1">
                    <i class="fas fa-coins text-[#FFD700] text-sm"></i>
                    <span id="user-balance" class="text-xl font-bold">0</span>
                </div>
            </div>
        </div>
    </header>

    <div id="main-app" class="hidden flex-1 overflow-y-auto p-4 space-y-4 pb-24"></div>

    <nav class="glass-panel rounded-t-3xl pb-2 pt-2 z-50 shrink-0">
        <div class="flex justify-around items-center h-14">
            <button onclick="router('home')" class="nav-item flex flex-col items-center gap-1 text-gray-500 transition-all duration-300 active" id="btn-home">
                <i class="fas fa-home text-lg transition-transform"></i>
                <span class="text-[9px] font-medium">Home</span>
            </button>
            <button onclick="router('tasks')" class="nav-item flex flex-col items-center gap-1 text-gray-500 transition-all duration-300" id="btn-tasks">
                <i class="fas fa-list-check text-lg transition-transform"></i>
                <span class="text-[9px] font-medium">Tasks</span>
            </button>
            <button onclick="router('wallet')" class="nav-item flex flex-col items-center gap-1 text-gray-500 transition-all duration-300" id="btn-wallet">
                <i class="fas fa-wallet text-lg transition-transform"></i>
                <span class="text-[9px] font-medium">Wallet</span>
            </button>
            <button onclick="router('history')" class="nav-item flex flex-col items-center gap-1 text-gray-500 transition-all duration-300" id="btn-history">
                <i class="fas fa-history text-lg transition-transform"></i>
                <span class="text-[9px] font-medium">History</span>
            </button>
            <button onclick="router('refer')" class="nav-item flex flex-col items-center gap-1 text-gray-500 transition-all duration-300" id="btn-refer">
                <i class="fas fa-users text-lg transition-transform"></i>
                <span class="text-[9px] font-medium">Refer</span>
            </button>
        </div>
    </nav>

    <script>
        const SUPABASE_URL = 'https://wnmwvbeydsrehtsnkfoc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndubXd2YmV5ZHNyZWh0c25rZm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzMDg4MzIsImV4cCI6MjA3OTg4NDgzMn0.4vSObxBEr8r11-dqkp9y6bVroMVoSTEnIOTF8Vo8sxk';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const tg = window.Telegram.WebApp;
        
        let currentUser = null;
        let appSettings = {};
        const MIN_AD_DURATION = 10000;

        // FIXED & OPTIMIZED INIT APP
        async function initApp() {
            tg.expand();
            const tgUser = tg.initDataUnsafe?.user;

            if (!tgUser) {
                document.getElementById('loading-screen').innerHTML = "<p class='text-red-500 font-bold'>Please open in Telegram</p>";
                return;
            }

            const { data: settings, error: settingsError } = await supabase.from('settings').select('*').single();
            if (settingsError || !settings) {
                Swal.fire('Error', 'Failed to load app settings', 'error');
                return;
            }
            appSettings = settings;

            let { data: user } = await supabase.from('users').select('*').eq('id', tgUser.id).single();

            if (!user) {
                const startParam = tg.initDataUnsafe?.start_param;
                let referrerId = null;

                if (startParam && startParam !== tgUser.id.toString()) {
                    const parsed = parseInt(startParam);
                    if (!isNaN(parsed) && parsed !== tgUser.id) {
                        referrerId = parsed;
                    }
                }

                // Anti-Cheat: Prevent same device multiple referral farming
                if (appSettings.anti_cheat_enabled && referrerId) {
                    const key = `ref_${referrerId}_used`;
                    if (localStorage.getItem(key)) {
                        referrerId = null;
                    } else {
                        localStorage.setItem(key, 'true');
                    }
                }

                const { data: newUser, error: insertError } = await supabase
                    .from('users')
                    .insert([{
                        id: tgUser.id,
                        first_name: tgUser.first_name || 'User',
                        username: tgUser.username || null,
                        photo_url: tgUser.photo_url || null,
                        referred_by: referrerId,
                        balance: referrerId ? 0 : 50
                    }])
                    .select()
                    .single();

                if (insertError) {
                    console.error(insertError);
                    Swal.fire('Error', 'Account creation failed', 'error');
                    return;
                }

                user = newUser;

                // Give referral bonus
                if (referrerId) {
                    await supabase.rpc('increment_referral', { referrer_id: referrerId });
                }
            }

            currentUser = user;
            updateHeaderUI();

            document.getElementById('loading-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            router('home');
        }

        function updateHeaderUI() {
            if (!currentUser) return;
            document.getElementById('user-name').innerText = currentUser.first_name || 'User';
            document.getElementById('user-balance').innerText = Number(currentUser.balance).toLocaleString();
            if (currentUser.photo_url) document.getElementById('user-photo').src = currentUser.photo_url;
        }

        function router(page) {
            document.querySelectorAll('.nav-item').forEach(btn => {
                btn.classList.remove('active', 'text-[#FFD700]'); 
                btn.classList.add('text-gray-500');
            });
            const activeBtn = document.getElementById(`btn-${page}`);
            if (activeBtn) {
                activeBtn.classList.add('active', 'text-[#FFD700]');
                activeBtn.classList.remove('text-gray-500');
            }

            const container = document.getElementById('main-app');
            if (page === 'home') renderHome(container);
            else if (page === 'tasks') renderTasks(container);
            else if (page === 'wallet') renderWallet(container);
            else if (page === 'history') renderHistory(container);
            else if (page === 'refer') renderRefer(container);
        }

        // বাকি সব ফাংশন (home, tasks, wallet, etc.) আগের মতোই রাখা হয়েছে
        // শুধুমাত্র ছোট ছোট ইম্প্রুভমেন্ট যোগ করা হয়েছে

        function renderHome(c) {
            const bdt = (currentUser.balance * appSettings.conversion_rate).toFixed(2);
            let banner = appSettings.home_banner_url ? `<img src="${appSettings.home_banner_url}" class="w-full h-40 object-cover rounded-2xl mt-4 shadow-xl">` : '';
            c.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl text-center">
                    <p class="text-gray-400 text-xs uppercase tracking-wider">Total Earnings</p>
                    <h1 class="text-5xl font-bold my-2">${Number(currentUser.balance).toLocaleString()}</h1>
                    <p class="text-lg gold-text font-bold">≈ ৳${bdt} BDT</p>
                    <button onclick="router('tasks')" class="mt-4 w-full py-3 gold-gradient text-black font-bold rounded-xl shadow-lg active:scale-95">Start Earning Now</button>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <div class="glass-panel p-4 rounded-xl text-center">
                        <i class="fas fa-users text-2xl text-blue-400 mb-2"></i>
                        <p class="text-2xl font-bold">${currentUser.referral_count}</p>
                        <p class="text-xs text-gray-400">Total Referrals</p>
                    </div>
                    <div class="glass-panel p-4 rounded-xl text-center">
                        <i class="fas fa-check-circle text-2xl text-green-400 mb-2"></i>
                        <p class="text-2xl font-bold">Active</p>
                        <p class="text-xs text-gray-400">Account Status</p>
                    </div>
                </div>
                ${banner}
            `;
        }

        async function renderTasks(c) {
            c.innerHTML = `<div class="loader"></div><p class="text-center text-gray-400">Loading tasks...</p>`;
            const { data: tasks } = await supabase.from('tasks').select('*').eq('is_active', true);
            const today = new Date().toISOString().split('T')[0];
            const { data: logs } = await supabase.from('task_logs').select('task_id').eq('user_id', currentUser.id).eq('created_at', today);
            const counts = logs ? logs.reduce((a, l) => { a[l.task_id] = (a[l.task_id] || 0) + 1; return a; }, {}) : {};
            const limit = appSettings.daily_task_limit || 10;
            const locked = appSettings.referral_lock && currentUser.referral_count < appSettings.min_referrals_req;

            let html = `<h2 class="text-xl font-bold mb-3">Daily Tasks</h2>`;
            if (locked) html += `<div class="bg-red-500/20 border border-red-500/50 p-4 rounded-xl text-center text-sm mb-4">Need ${appSettings.min_referrals_req - currentUser.referral_count} more referrals to unlock tasks!</div>`;

            html += `<div class="space-y-3">`;
            tasks?.forEach(t => {
                const done = counts[t.id] || 0;
                const disabled = locked || done >= limit;
                const icon = t.task_type === 'video' ? 'play-circle' : t.task_type === 'telegram' ? 'paper-plane' : 'globe';
                html += `
                    <div class="glass-panel p-4 rounded-xl flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-full bg-[#FFD700]/20 flex items-center justify-center text-[#FFD700]">
                                <i class="fas fa-${icon}"></i>
                            </div>
                            <div>
                                <h4 class="font-bold">${t.title}</h4>
                                <p class="text-xs text-gray-400">+\( {t.reward} points • \){done}/${limit}</p>
                            </div>
                        </div>
                        <button onclick="handleTask(\( {t.id}, \){t.reward}, '\( {t.task_type}', ' \){t.link || ''}')" 
                            ${disabled ? 'disabled' : ''} 
                            class="px-5 py-2 rounded-lg font-bold text-sm ${disabled ? 'bg-gray-600 opacity-50' : 'bg-[#FFD700] text-black'}">
                            ${done >= limit ? 'Completed' : t.task_type === 'video' ? 'Watch' : 'Start'}
                        </button>
                    </div>`;
            });
            html += `</div>`;
            c.innerHTML = html;
        }

        window.handleTask = async (taskId, reward, type, link) => {
            const start = Date.now();
            const check = async () => {
                if (Date.now() - start < MIN_AD_DURATION) {
                    return Swal.fire('Too Fast!', 'Watch ad for at least 10 seconds', 'warning');
                }
                const { data } = await supabase.rpc('claim_task', {
                    user_id_input: currentUser.id,
                    task_id_input: taskId,
                    reward_amount: reward,
                    daily_limit_input: appSettings.daily_task_limit
                });
                if (data?.success) {
                    currentUser.balance += reward;
                    updateHeaderUI();
                    Swal.fire({ icon: 'success', title: `+${reward} Points!`, toast: true, position: 'top-end', timer: 2000, showConfirmButton: false });
                    router('tasks');
                } else {
                    Swal.fire('Limit Reached', data?.message || 'Try tomorrow', 'info');
                }
            };

            if (type === 'video' || type === 'web') {
                if (window.show_10197154) window.show_10197154().then(check).catch(check);
                else check();
            } else if (type === 'telegram' && link) {
                window.open(link, '_blank');
                setTimeout(check, 3000);
            }
        };

        function renderWallet(c) {
            const bdt = (currentUser.balance * appSettings.conversion_rate).toFixed(2);
            c.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl text-center mb-6">
                    <p class="text-gray-400 text-sm">Available Balance</p>
                    <h1 class="text-4xl font-bold gold-text my-3">৳${bdt}</h1>
                    <p class="text-xs text-gray-500">Minimum: ৳${appSettings.min_withdraw_amount}</p>
                </div>
                <div class="space-y-4">
                    <input type="text" id="withdraw-number" placeholder="Bkash Number (01xxxxxxxxx)" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 focus:border-[#FFD700] outline-none">
                    <input type="number" id="withdraw-amount" placeholder="Amount in BDT" class="w-full p-4 rounded-xl bg-white/5 border border-white/10 focus:border-[#FFD700] outline-none">
                    <button onclick="processWithdraw()" class="w-full py-4 gold-gradient text-black font-bold rounded-xl shadow-lg active:scale-95">Withdraw Now</button>
                </div>
            `;
        }

        window.processWithdraw = async () => {
            const num = document.getElementById('withdraw-number').value.trim();
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            if (!num || !amt) return Swal.fire('Error', 'Fill all fields', 'warning');
            if (amt < appSettings.min_withdraw_amount) return Swal.fire('Error', `Minimum ৳${appSettings.min_withdraw_amount}`, 'warning');
            if (currentUser.balance < amt / appSettings.conversion_rate) return Swal.fire('Error', 'Low balance', 'error');

            if (window.show_10197154) await window.show_10197154().catch(() => {});

            const { error } = await supabase.from('withdrawals').insert({
                user_id: currentUser.id,
                method: 'Bkash',
                number: num,
                amount_bdt: amt,
                points_deducted: amt / appSettings.conversion_rate
            });

            if (!error) {
                await supabase.rpc('increment_balance', { user_id: currentUser.id, amount: -(amt / appSettings.conversion_rate) });
                currentUser.balance -= amt / appSettings.conversion_rate;
                updateHeaderUI();
                Swal.fire('Success!', 'Withdrawal request sent', 'success');
                router('history');
            } else {
                Swal.fire('Failed', 'Try again later', 'error');
            }
        };

        async function renderHistory(c) {
            c.innerHTML = `<div class="loader"></div>`;
            const { data: list } = await supabase.from('withdrawals').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
            let html = `<h2 class="text-xl font-bold mb-4">Withdrawal History</h2>`;
            if (!list?.length) html += `<p class="text-center text-gray-500 mt-10">No withdrawals yet</p>`;
            else {
                html += `<div class="space-y-3">`;
                list.forEach(w => {
                    const status = w.status === 'paid' ? {c:'text-green-400', i:'check-circle'} : w.status === 'rejected' ? {c:'text-red-400', i:'times-circle'} : {c:'text-yellow-400', i:'clock'};
                    html += `
                        <div class="glass-panel p-4 rounded-xl flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">Money Bag</div>
                                <div>
                                    <p class="font-bold text-[#FFD700]">৳${w.amount_bdt}</p>
                                    <p class="text-xs text-gray-400">\( {w.method} • \){new Date(w.created_at).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <span class="text-sm font-bold \( {status.c}"><i class="fas fa- \){status.i}"></i> ${w.status.toUpperCase()}</span>
                        </div>`;
                });
                html += `</div>`;
            }
            c.innerHTML = html;
        }

        function renderRefer(c) {
            const link = `https://t.me/\( {appSettings.bot_username || 'Your10x_bot'}?start= \){currentUser.id}`;
            c.innerHTML = `
                <div class="glass-panel p-6 rounded-2xl text-center mt-4">
                    <h2 class="text-3xl font-bold">Invite Friends & Earn</h2>
                    <p class="text-sm text-gray-400 mt-2">Get 50 points instantly per referral!</p>
                </div>
                <div class="glass-panel p-4 rounded-xl mt-4 flex items-center gap-3">
                    <input type="text" value="${link}" readonly id="ref-link" class="bg-transparent text-xs flex-1 outline-none">
                    <button onclick="copyLink()" class="px-4 py-2 bg-[#FFD700] text-black rounded-lg font-bold">Copy</button>
                </div>
                <div class="grid grid-cols-2 gap-4 mt-6">
                    <div class="glass-panel p-5 rounded-xl text-center">
                        <p class="text-sm text-gray-400">Total Referrals</p>
                        <h3 class="text-3xl font-bold text-[#FFD700] mt-2">${currentUser.referral_count}</h3>
                    </div>
                    <div class="glass-panel p-5 rounded-xl text-center">
                        <p class="text-sm text-gray-400">Bonus Earned</p>
                        <h3 class="text-3xl font-bold text-[#FFD700] mt-2">${currentUser.referral_count * 50}</h3>
                    </div>
                </div>
            `;
        }

        window.copyLink = () => {
            const el = document.getElementById('ref-link');
            el.select(); document.execCommand('copy');
            Swal.fire({ title: 'Copied!', icon: 'success', toast: true, position: 'top-end', timer: 1500, showConfirmButton: false });
        };

        // Start App
        initApp();
    </script>
</body>
</html>
