<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EarnApp User</title>

    <!-- 1. Essential CDNs -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 2. GigaPub Ad Script -->
    <script src="https://ad.gigapub.tech/script?id=4413"></script>

    <!-- 3. Styles -->
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .loader { width: 40px; height: 40px; border: 4px solid #1e293b; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-press:active { transform: scale(0.96); }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://uqyhgzhesvlvclszkkkm.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxeWhnemhlc3ZsdmNsc3pra2ttIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMTIxNzYsImV4cCI6MjA3OTY4ODE3Nn0.X9sZ8V6fOcMbXWnbkMonT-gE1xH-TEDur3Aa7aEGjDc";
        const IPINFO_TOKEN = "1151161c93b97a"; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- MAIN USER APP COMPONENT ---
        const UserApp = () => {
            // States
            const [loading, setLoading] = useState(true);
            const [view, setView] = useState('auth'); // auth, home, withdraw
            const [user, setUser] = useState(null);
            const [tasks, setTasks] = useState([]);
            const [settings, setSettings] = useState({});
            
            // VPN & Error States
            const [vpnBlocked, setVpnBlocked] = useState(false);
            const [detectedCountry, setDetectedCountry] = useState('Checking...');
            const [errorMessage, setErrorMessage] = useState('');

            // Inputs
            const [loginId, setLoginId] = useState('');
            const [username, setUsername] = useState('');
            const [withdrawAmount, setWithdrawAmount] = useState('');
            const [wallet, setWallet] = useState('');

            // --- 1. INITIALIZE APP ---
            useEffect(() => {
                init();
            }, []);

            const init = async () => {
                setLoading(true);
                try {
                    // A. Fetch App Settings
                    const { data: set, error } = await supabase.from('settings').select('*').eq('id', 1).single();
                    if (error) throw new Error("Could not load app settings.");
                    setSettings(set);

                    // B. Maintenance Check
                    if (set.maintenance_mode) {
                        setErrorMessage("Server under maintenance. Please come back later.");
                        setLoading(false);
                        return;
                    }

                    // C. VPN Check
                    if (set.vpn_enabled) {
                        const passed = await checkVPN(set.allowed_countries);
                        if (!passed) {
                            setLoading(false); 
                            return; // Stop here if blocked
                        }
                    }

                    // D. Auto Login (if ID saved)
                    const savedId = localStorage.getItem('tg_id');
                    if (savedId) {
                        await handleLogin(savedId, localStorage.getItem('tg_user') || 'User');
                    } else {
                        setLoading(false);
                        setView('auth');
                    }

                } catch (err) {
                    console.error(err);
                    setErrorMessage("Connection Error: " + err.message);
                    setLoading(false);
                }
            };

            // --- 2. ROBUST VPN CHECKER ---
            const checkVPN = async (allowedList) => {
                try {
                    const response = await fetch(`https://ipinfo.io/json?token=${IPINFO_TOKEN}`);
                    if (!response.ok) throw new Error("IP Service Unavailable");
                    
                    const data = await response.json();
                    setDetectedCountry(data.country); // e.g. 'US'

                    const allowed = allowedList.split(',').map(c => c.trim().toUpperCase());
                    
                    if (!allowed.includes(data.country)) {
                        setVpnBlocked(true);
                        return false;
                    }
                    return true;
                } catch (e) {
                    console.warn("VPN Check failed, proceeding with caution:", e);
                    // If IP check fails, we allow access but warn console (or block if you prefer strict security)
                    return true; 
                }
            };

            // --- 3. AUTHENTICATION ---
            const handleLogin = async (tgId, name) => {
                setLoading(true);
                try {
                    // Check if profile exists
                    let { data: profile } = await supabase.from('profiles').select('*').eq('telegram_id', tgId).single();

                    // If not, create new
                    if (!profile) {
                        const { data: newProfile, error } = await supabase.from('profiles').insert([
                            { id: crypto.randomUUID(), telegram_id: tgId, username: name, balance: 0 }
                        ]).select().single();
                        
                        if (error) throw error;
                        profile = newProfile;
                    }

                    if (profile.is_banned) {
                        setErrorMessage("Your account has been banned.");
                        setLoading(false);
                        return;
                    }

                    // Success
                    setUser(profile);
                    localStorage.setItem('tg_id', tgId);
                    localStorage.setItem('tg_user', name);
                    
                    // Fetch Tasks
                    const { data: tData } = await supabase.from('tasks').select('*').order('id', { ascending: false });
                    setTasks(tData || []);
                    
                    setView('home');

                } catch (e) {
                    alert("Login failed: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            // --- 4. EARNING LOGIC ---
            const handleTask = (task) => {
                // GigaPub Logic
                if (window.showGiga) {
                    window.showGiga()
                        .then(() => verifyAndReward(task))
                        .catch((e) => {
                            console.log("Ad closed or failed", e);
                            // Verify ad fail policy. For now, we reward to keep users happy
                            verifyAndReward(task);
                        });
                } else {
                    // Fallback for testing
                    alert("Ad Script loading... wait 2 seconds.");
                    setTimeout(() => verifyAndReward(task), 2000);
                }
            };

            const verifyAndReward = async (task) => {
                // Optimistic Update (Instant UI feedback)
                const newBalance = user.balance + task.reward;
                setUser(prev => ({ ...prev, balance: newBalance }));
                
                // Database Update
                await supabase.from('profiles').update({ balance: newBalance }).eq('id', user.id);
                
                // Optional: Vibrate or sound
                if(navigator.vibrate) navigator.vibrate(50);
            };

            // --- 5. WITHDRAWAL LOGIC ---
            const submitWithdraw = async () => {
                if (!wallet || !withdrawAmount) return alert("Fill all fields");
                if (parseInt(withdrawAmount) > user.balance) return alert("Insufficient Balance");

                setLoading(true);
                const { error } = await supabase.from('withdrawals').insert([
                    { 
                        user_id: user.id, 
                        amount: parseInt(withdrawAmount), 
                        method: "USDT/Crypto", 
                        wallet: wallet 
                    }
                ]);

                if (!error) {
                    const newBal = user.balance - parseInt(withdrawAmount);
                    setUser({ ...user, balance: newBal });
                    await supabase.from('profiles').update({ balance: newBal }).eq('id', user.id);
                    alert("Withdrawal Requested!");
                    setView('home');
                } else {
                    alert("Error: " + error.message);
                }
                setLoading(false);
            };

            // --- RENDER HELPERS ---

            if (loading) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900">
                    <div className="loader"></div>
                </div>
            );

            if (errorMessage) return (
                <div className="min-h-screen flex items-center justify-center bg-slate-900 p-6 text-center">
                    <div className="glass p-6 rounded-xl border-red-500/50 border">
                        <i className="fa-solid fa-triangle-exclamation text-4xl text-red-500 mb-4"></i>
                        <h2 className="text-xl font-bold text-white mb-2">Error</h2>
                        <p className="text-gray-400">{errorMessage}</p>
                    </div>
                </div>
            );

            if (vpnBlocked) return (
                <div className="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 text-white p-6 text-center">
                    <div className="w-20 h-20 rounded-full bg-red-500/20 flex items-center justify-center mb-6 animate-pulse">
                        <i className="fa-solid fa-shield-halved text-4xl text-red-500"></i>
                    </div>
                    <h2 className="text-3xl font-bold mb-2">Access Restricted</h2>
                    <p className="text-gray-400 mb-6 max-w-xs mx-auto">
                        This app is only available in: <br/>
                        <span className="text-white font-mono font-bold">{settings.allowed_countries}</span>
                    </p>
                    <div className="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 mb-8">
                        <span className="text-xs text-gray-500 uppercase block mb-1">Your Location</span>
                        <span className="text-xl font-bold text-yellow-400">{detectedCountry}</span>
                    </div>
                    <button onClick={() => window.location.reload()} className="px-8 py-3 bg-blue-600 rounded-full font-bold shadow-lg shadow-blue-600/30 btn-press">
                        Refetch Location
                    </button>
                </div>
            );

            // --- VIEW: LOGIN ---
            if (view === 'auth') return (
                <div className="min-h-screen flex flex-col items-center justify-center p-6 relative overflow-hidden">
                    {/* Background Blobs */}
                    <div className="absolute top-0 left-0 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2"></div>
                    <div className="absolute bottom-0 right-0 w-64 h-64 bg-purple-600/20 rounded-full blur-3xl translate-x-1/2 translate-y-1/2"></div>

                    <div className="glass w-full max-w-sm p-8 rounded-3xl relative z-10">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                                <i className="fa-solid fa-sack-dollar text-3xl text-white"></i>
                            </div>
                            <h1 className="text-2xl font-bold text-white">Welcome Back</h1>
                            <p className="text-slate-400 text-sm">Login to start earning rewards</p>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="text-xs text-slate-400 ml-1">Telegram ID</label>
                                <input 
                                    type="number" 
                                    value={loginId}
                                    onChange={e => setLoginId(e.target.value)}
                                    className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition"
                                    placeholder="e.g. 12345678"
                                />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 ml-1">Username</label>
                                <input 
                                    type="text" 
                                    value={username}
                                    onChange={e => setUsername(e.target.value)}
                                    className="w-full bg-slate-800/50 border border-slate-700 rounded-xl p-3 text-white focus:border-blue-500 outline-none transition"
                                    placeholder="Your Name"
                                />
                            </div>
                            <button 
                                onClick={() => loginId && handleLogin(loginId, username || 'Anonymous')}
                                className="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-600/30 btn-press mt-2"
                            >
                                Continue
                            </button>
                        </div>
                    </div>
                </div>
            );

            // --- VIEW: DASHBOARD (HOME) ---
            return (
                <div className="min-h-screen bg-slate-900 pb-24">
                    {/* Top Stats Card */}
                    <div className="relative bg-gradient-to-b from-blue-900 to-slate-900 p-6 pb-12 rounded-b-[2.5rem] shadow-2xl">
                        <div className="flex justify-between items-start mb-6">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white font-bold border border-white/10">
                                    {user.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <h3 className="font-bold text-white leading-tight">{user.username}</h3>
                                    <span className="text-xs text-green-400 flex items-center gap-1">
                                        <div className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div> Online
                                    </span>
                                </div>
                            </div>
                            <div className="bg-white/10 px-3 py-1 rounded-full border border-white/10 text-xs text-white">
                                <i className="fa-solid fa-earth-americas mr-1"></i> {detectedCountry}
                            </div>
                        </div>
                        
                        <div className="text-center">
                            <span className="text-slate-400 text-sm font-medium uppercase tracking-wider">Total Balance</span>
                            <div className="text-5xl font-black text-white mt-2 drop-shadow-lg">
                                {user.balance.toLocaleString()}
                            </div>
                            <div className="text-yellow-400 font-bold mt-1 text-sm">GOLD COINS</div>
                        </div>

                        {/* Action Buttons */}
                        <div className="absolute -bottom-6 left-6 right-6 flex gap-4">
                            <button 
                                onClick={() => setView('withdraw')}
                                className="flex-1 bg-slate-800 border border-slate-700 text-white py-3 rounded-xl shadow-lg btn-press flex items-center justify-center gap-2 font-bold"
                            >
                                <i className="fa-solid fa-wallet text-blue-400"></i> Withdraw
                            </button>
                            <button 
                                onClick={() => setView('home')}
                                className="flex-1 bg-slate-800 border border-slate-700 text-white py-3 rounded-xl shadow-lg btn-press flex items-center justify-center gap-2 font-bold"
                            >
                                <i className="fa-solid fa-list text-green-400"></i> Tasks
                            </button>
                        </div>
                    </div>

                    {/* Scrollable Content */}
                    <div className="mt-12 px-5">
                        {/* Announcement Banner */}
                        {settings.announcement && (
                            <div className="mb-6 bg-gradient-to-r from-indigo-900/50 to-purple-900/50 border border-indigo-500/30 p-4 rounded-2xl flex gap-3 items-start">
                                <div className="bg-indigo-500/20 p-2 rounded-lg shrink-0">
                                    <i className="fa-solid fa-bullhorn text-indigo-400"></i>
                                </div>
                                <p className="text-sm text-indigo-100 leading-relaxed pt-1">{settings.announcement}</p>
                            </div>
                        )}

                        {/* Home: Task List */}
                        {view === 'home' && (
                            <div>
                                <h3 className="text-slate-400 font-bold mb-4 uppercase text-xs tracking-wider">Available Tasks ({tasks.length})</h3>
                                <div className="space-y-3">
                                    {tasks.length === 0 ? (
                                        <div className="text-center py-10 text-gray-500">
                                            <i className="fa-solid fa-box-open text-4xl mb-2 opacity-50"></i>
                                            <p>No tasks right now.</p>
                                        </div>
                                    ) : (
                                        tasks.map((task, i) => (
                                            <div 
                                                key={task.id} 
                                                onClick={() => handleTask(task)}
                                                className="glass p-4 rounded-2xl flex items-center justify-between group active:scale-95 transition cursor-pointer hover:bg-slate-800"
                                            >
                                                <div className="flex items-center gap-4">
                                                    <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-600/20 to-purple-600/20 flex items-center justify-center text-blue-400 group-hover:scale-110 transition">
                                                        <i className="fa-solid fa-play"></i>
                                                    </div>
                                                    <div>
                                                        <h4 className="font-bold text-white text-sm">{task.title}</h4>
                                                        <p className="text-xs text-slate-400 mt-1">
                                                            <i className="fa-regular fa-clock mr-1"></i> {task.timer} seconds
                                                        </p>
                                                    </div>
                                                </div>
                                                <div className="bg-yellow-500/10 text-yellow-500 px-3 py-1 rounded-lg font-bold text-sm border border-yellow-500/20">
                                                    +{task.reward}
                                                </div>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        )}

                        {/* Withdraw View */}
                        {view === 'withdraw' && (
                            <div className="glass p-6 rounded-3xl animate-fade-in">
                                <h3 className="text-xl font-bold text-white mb-6">Request Payout</h3>
                                
                                <div className="space-y-5">
                                    <div>
                                        <label className="text-xs text-slate-400 ml-1 block mb-2">Wallet Address (TRC20/Binance)</label>
                                        <div className="relative">
                                            <i className="fa-solid fa-qrcode absolute left-4 top-3.5 text-slate-500"></i>
                                            <input 
                                                type="text" 
                                                value={wallet}
                                                onChange={e => setWallet(e.target.value)}
                                                placeholder="Paste address here..."
                                                className="w-full bg-slate-900 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-white focus:border-blue-500 outline-none"
                                            />
                                        </div>
                                    </div>

                                    <div>
                                        <label className="text-xs text-slate-400 ml-1 block mb-2">Amount (Coins)</label>
                                        <div className="relative">
                                            <i className="fa-solid fa-coins absolute left-4 top-3.5 text-slate-500"></i>
                                            <input 
                                                type="number" 
                                                value={withdrawAmount}
                                                onChange={e => setWithdrawAmount(e.target.value)}
                                                placeholder={`Min: 1000 | Max: ${user.balance}`}
                                                className="w-full bg-slate-900 border border-slate-700 rounded-xl py-3 pl-10 pr-4 text-white focus:border-blue-500 outline-none font-mono"
                                            />
                                        </div>
                                        <div className="text-right mt-2">
                                            <button 
                                                onClick={() => setWithdrawAmount(user.balance)}
                                                className="text-xs text-blue-400 hover:text-blue-300 font-bold"
                                            >
                                                Max Amount
                                            </button>
                                        </div>
                                    </div>

                                    <button 
                                        onClick={submitWithdraw}
                                        className="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg shadow-green-600/20 btn-press"
                                    >
                                        Confirm Withdraw
                                    </button>
                                    
                                    <button 
                                        onClick={() => setView('home')}
                                        className="w-full text-slate-500 text-sm font-bold py-2"
                                    >
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UserApp />);
    </script>
</body>
</html>
