<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>bKash Earn Free TK</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        :root { --primary: #e11584; --success: #10b981; --gray: #f1f5f9; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Hind Siliguri', sans-serif; background: linear-gradient(135deg, #ff006e, #8338ec); color: #1e293b; min-height: 100vh; }
        .container { max-width: 480px; margin: 0 auto; background: white; border-radius: 20px 20px 0 0; overflow: hidden; height: 100vh; display: flex; flex-direction: column; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .header { background: var(--primary); color: white; padding: 30px 20px; text-align: center; }
        .balance-card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 16px; margin-top: 15px; }
        .balance-amount { font-size: 42px; font-weight: 700; }
        .actions { padding: 20px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        .btn { padding: 16px; border-radius: 16px; font-weight: 600; font-size: 16px; color: white; }
        .btn-withdraw { background: #06d6a0; }
        .btn-history { background: #8b5cf6; }
        .btn-refer { background: #fb923c; }
        .task-section { flex: 1; overflow-y: auto; padding: 20px; }
        .task-item { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #eee; }
        .task-btn { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: 700; margin-top: 12px; }
        .task-btn:disabled { background: #94a3b8; cursor: not-allowed; }
        .countdown { color: #e11584; font-weight: bold; font-size: 18px; text-align: center; margin: 10px 0; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 999; justify-content: center; align-items: center; padding: 20px; }
        .modal-content { background: white; border-radius: 20px; width: 100%; max-width: 420px; max-height: 90vh; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>bKash Earn Free TK</h1>
            <div class="balance-card">
                <div style="font-size:16px; opacity:0.9;">মোট ব্যালেন্স</div>
                <div class="balance-amount" id="user-balance">৳0.00</div>
            </div>
            <div style="margin-top:10px; font-size:15px;">Welcome, <span id="user-name">User</span></div>
        </div>

        <div class="actions">
            <button class="btn btn-withdraw" onclick="openWithdraw()">উইথড্র</button>
            <button class="btn btn-history" onclick="showHistory()">হিস্টোরি</button>
            <button class="btn btn-refer" onclick="showRefer()">রেফার করুন</button>
        </div>

        <div class="task-section">
            <h3 style="text-align:center; margin:25px 0 15px; font-size:20px;">দৈনিক টাস্ক সম্পন্ন করুন</h3>
            <div id="task-list">লোড হচ্ছে...</div>
        </div>
    </div>

    <div id="modal" class="modal"></div>

    <script>
        const supabase = window.supabase.createClient('https://pcnqgdmusmcpstxfntgn.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFz ZSwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzODMwMzUsImV4cCI6MjA3ODk1OTAzNX0.a8CjieXPwU29O9qXTSG7xcHrj3NWsxvb-ca8MuXx7OE');
        const tg = window.Telegram.WebApp;
        tg.ready(); tg.expand();

        let user = { id: null, balance: 0, referral_code: '' };
        let watchingAds = {};

        window.onload = async () => {
            if (!tg.initDataUnsafe?.user) return alert('শুধুমাত্র টেলিগ্রাম থেকে খুলুন');
            user.id = tg.initDataUnsafe.user.id;
            document.getElementById('user-name').innerText = tg.initDataUnsafe.user.first_name || 'User';

            await loadUser();
            await loadTasks();
        };

        async function loadUser() {
            let { data } = await supabase.from('users').select('*').eq('id', user.id).single();
            if (!data) {
                const refCode = tg.initDataUnsafe.start_param || localStorage.getItem('ref');
                const refUser = refCode ? await supabase.from('users').select('id').eq('referral_code', refCode).single() : null;
                const newCode = 'REF' + Date.now().toString().slice(-6);
                await supabase.from('users').insert({
                    id: user.id,
                    name: tg.initDataUnsafe.user.first_name,
                    referral_code: newCode,
                    referred_by: refUser?.data?.id || null,
                    balance: 0,
                    ip_address: 'unknown'
                });
                data = (await supabase.from('users').select('*').eq('id', user.id).single()).data;
            }
            user.balance = data.balance;
            user.referral_code = data.referral_code;
            document.getElementById('user-balance').innerText = `৳${parseFloat(data.balance).toFixed(2)}`;
        }

        async function loadTasks() {
            const { data: tasks } = await supabase.from('tasks').select('*').eq('active', true);
            const { data: completed } = await supabase.from('task_completions').select('*').eq('user_id', user.id);

            const container = document.getElementById('task-list');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#666; padding:50px;">কোনো টাস্ক নেই</p>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                const comp = completed.find(c => c.task_id === task.id);
                const now = Date.now();
                const cooldownEnd = comp ? new Date(comp.completed_at).getTime() + (task.cooldown_hours * 3600000) : 0;

                let btn = '';
                if (comp && now < cooldownEnd) {
                    const remain = Math.floor((cooldownEnd - now) / 1000);
                    const h = Math.floor(remain / 3600).toString().padStart(2, '0');
                    const m = Math.floor((remain % 3600) / 60).toString().padStart(2, '0');
                    const s = (remain % 60).toString().padStart(2, '0');
                    btn = `<div class="countdown">পুনরায়: ${h}:${m}:${s}</div><button class="task-btn" disabled>অপেক্ষা করুন</button>`;
                } else {
                    btn = `<button class="task-btn" onclick="startTask(${task.id}, ${task.ads_required}, ${task.reward})">শুরু করুন → ৳${task.reward}</button>`;
                }

                return `
                    <div class="task-item">
                        <h3>${task.title}</h3>
                        <p>দেখতে হবে: ${task.ads_required}টি বিজ্ঞাপন</p>
                        <p style="color:green; font-weight:bold;">পুরস্কার: ৳${task.reward}</p>
                        ${btn}
                    </div>`;
            }).join('');

            // Auto refresh countdown
            setInterval(() => {
                if (document.querySelector('.countdown')) loadTasks();
            }, 1000);
        }

        window.startTask = async (taskId, adsRequired, reward) => {
            if (watchingAds[taskId]) return;
            watchingAds[taskId] = { count: 0, required: adsRequired };

            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = `বিজ্ঞাপন দেখুন (0/${adsRequired})`;

            for (let i = 1; i <= adsRequired; i++) {
                btn.innerHTML = `দেখছেন... (${i}/${adsRequired})`;
                try {
                    // Replace with your real ad network
                    await new Promise(resolve => {
                        window.showGigaAd?.() || setTimeout(resolve, 30000); // fallback 30s
                        setTimeout(resolve, 35000); // max 35s
                    });
                    watchingAds[taskId].count++;
                    btn.innerHTML = `দেখছেন... (${watchingAds[taskId].count}/${adsRequired})`;
                } catch (e) {
                    alert('বিজ্ঞাপন লোড হয়নি! আবার চেষ্টা করুন।');
                    btn.disabled = false;
                    btn.innerHTML = 'আবার চেষ্টা করুন';
                    delete watchingAds[taskId];
                    return;
                }
            }

            // Only if all ads watched
            if (watchingAds[taskId].count === adsRequired) {
                await claimTask(taskId, reward);
            }
            delete watchingAds[taskId];
        };

        async function claimTask(taskId, reward) {
            const { error } = await supabase.from('task_completions').insert({
                user_id: user.id,
                task_id: taskId,
                completed_at: new Date().toISOString()
            });

            if (!error) {
                await supabase.rpc('increment_balance', { user_id: user.id, amount: reward });
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                alert(`অভিনন্দন! ৳${reward} যোগ হয়েছে`);
                loadUser();
                loadTasks();
            }
        }

        // Withdraw, History, Refer (same as before but withdrawal goes to pending)
        async function openWithdraw() {
            const { data: methods } = await supabase.from('payment_methods').select('*').eq('active', true);
            const options = methods.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
            document.getElementById('modal').innerHTML = `
                <div class="modal-content">
                    <div style="background:var(--primary); color:white; padding:20px; text-align:center; border-radius:20px 20px 0 0;">
                        <h2>টাকা উইথড্র করুন</h2>
                    </div>
                    <div style="padding:25px;">
                        <select id="method" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px;">${options}</select>
                        <input type="text" id="number" placeholder="মোবাইল নম্বর" style="width:100%; padding:15px; margin-bottom:15px; border-radius:12px;">
                        <input type="number" id="amount" placeholder="পরিমাণ (মিনিমাম ৳50)" style="width:100%; padding:15px; margin-bottom:20px; border-radius:12px;">
                        <div style="display:flex; gap:10px;">
                            <button onclick="closeModal()" class="btn" style="background:#ddd; flex:1;">বাতিল</button>
                            <button onclick="submitWithdraw()" class="btn" style="background:#06d6a0; flex:1;">সাবমিট</button>
                        </div>
                    </div>
                </div>`;
            document.getElementById('modal').style.display = 'flex';
        }

        window.submitWithdraw = async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            if (amount < 50 || amount > user.balance) return alert('ভুল পরিমাণ');
            await supabase.from('withdrawals').insert({
                user_id: user.id,
                method_id: document.getElementById('method').value,
                account: document.getElementById('number').value,
                amount: amount,
                status: 'pending'
            });
            alert('উইথড্র রিকোয়েস্ট পাঠানো হয়েছে! অ্যাডমিন রিভিউ করবে।');
            closeModal();
        };

        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        // showHistory(), showRefer() same as before
    </script>
</body>
</html>
