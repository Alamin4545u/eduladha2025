<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Reward Center</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        :root {
            --background-color: #1a1c23; --card-color: #242731; --primary-accent: #8a2be2;
            --secondary-accent: #4158D0; --text-color: #ffffff; --text-muted: #a9a9c4;
            --success-color: #00b894; --error-color: #d63031; --nav-bar-color: #2a2d39;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color);
            margin: 0; padding: 20px 20px 80px 20px; text-align: center; display: flex;
            justify-content: flex-start; align-items: center; flex-direction: column; min-height: 100vh;
        }
        .page { display: none; width: 100%; max-width: 420px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .container { background-color: var(--card-color); border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.25); }
        h2 { font-size: 1.4rem; margin-top: 0; }
        
        /* --- Navigation Bar --- */
        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--nav-bar-color);
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2); border-top: 1px solid #333;
        }
        .nav-button {
            background: none; border: none; color: var(--text-muted); display: flex;
            flex-direction: column; align-items: center; font-size: 12px; font-family: 'Poppins';
            padding: 5px; border-radius: 8px; width: 80px; transition: color 0.2s; cursor: pointer;
        }
        .nav-button.active { color: var(--primary-accent); }
        .nav-button svg { width: 24px; height: 24px; margin-bottom: 4px; }

        /* --- Home Page --- */
        .profile-header { display: flex; align-items: center; margin-bottom: 20px; text-align: left; }
        .profile-header img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; }
        .profile-header h2 { margin: 0; font-size: 1.2rem; }
        .profile-header p { margin: 2px 0 0; color: var(--text-muted); font-size: 0.9rem; }
        .balance-card { background: linear-gradient(135deg, var(--primary-accent), var(--secondary-accent)); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .balance-card h3 { margin: 0; opacity: 0.9; }
        .balance-card .balance-amount { font-size: 2.5rem; font-weight: 700; }
        .home-buttons button { width: 100%; margin-bottom: 12px; padding: 15px; font-size: 1rem; cursor: pointer; border:none; color: white; }
        #start-task-btn { background-color: var(--success-color); }
        #extra-income-btn { background-color: var(--secondary-accent); }
        .task-summary { background: #333644; padding: 15px; border-radius: 12px; }
        .cover-banner { width: 100%; border-radius: 12px; margin-top: 15px; display: none; }
        
        /* --- Withdraw & Profile Pages --- */
        .page-content { padding: 20px; }
        .info-group { text-align: left; margin-bottom: 20px; }
        .info-group label { display: block; color: var(--text-muted); margin-bottom: 5px; }
        .info-group p { background: #333644; padding: 12px; border-radius: 8px; margin: 0; word-wrap: break-word; }
        #logout-btn { background-color: var(--error-color); }

        /* --- Task Pages --- */
        .task-list-container { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .task-item { display: flex; justify-content: space-between; align-items: center; background: #333644; padding: 15px; border-radius: 12px; margin-bottom: 10px; cursor: pointer; }
        .task-item-info { text-align: left; }
        .task-item-info span { font-weight: 600; font-size: 1.1rem; }
        .task-item-info p { margin: 2px 0 0; font-size: 0.8rem; color: var(--text-muted); }
        .task-item .status-icon { font-size: 1.5rem; }
        .sub-task-progress { width: 100%; background: #444; border-radius: 5px; height: 8px; margin-top: 8px; }
        .sub-task-progress div { background: var(--success-color); height: 100%; border-radius: 5px; }

        .sub-task-view .container { padding: 15px; }
        .sub-task-view .header { display: flex; align-items: center; margin-bottom: 15px; }
        .sub-task-view #back-btn { background: none; border: none; font-size: 1.5rem; color: #fff; cursor: pointer; padding: 0; }
        .sub-task-view h3 { margin: 0 0 0 15px; }
        .sub-task-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .sub-task-item { background: #444; color: #fff; border: none; border-radius: 8px; aspect-ratio: 1/1; display: flex; justify-content: center; align-items: center; font-size: 1.2rem; cursor: pointer; }
        .sub-task-item.completed { background: var(--success-color); cursor: default; }
        .sub-task-item:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Loading Overlay --- */
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; color: #fff; }
        .loader { border: 4px solid rgba(255,255,255,0.2); border-top: 4px solid var(--primary-accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        #loading-text { margin-top: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    
    <div id="loading-overlay"><div class="loader"></div><p id="loading-text">Loading...</p></div>

    <!-- Pages -->
    <div id="home-page" class="page">
        <div class="container">
            <header class="profile-header">
                <img id="home-avatar" src="https://telegram.org/img/t_logo.png" alt="Avatar">
                <div class="welcome-text">
                    <h2 id="home-welcome-name">Welcome!</h2>
                    <p>Let's earn some rewards today.</p>
                </div>
            </header>
            <section class="balance-card">
                <h3>Current Balance</h3>
                <p class="balance-amount" id="home-balance">0.00</p>
            </section>
            <div class="home-buttons">
                <button id="start-task-btn">Start Task</button>
                <button id="extra-income-btn">Extra Income</button>
            </div>
            <div class="task-summary">
                <p>Today's Tasks Completed: <strong id="tasks-completed-summary">0/10</strong></p>
            </div>
            <img id="cover-banner" class="cover-banner" src="" alt="Promotional Cover">
        </div>
    </div>

    <div id="main-task-page" class="page">
        <div class="container">
            <div style="display:flex; align-items:center; margin-bottom:20px;">
                <button id="main-task-back-btn" style="background:none; border:none; font-size:1.5rem; color:#fff; cursor:pointer;">&larr;</button>
                <h2 style="margin:0 auto;">Main Tasks</h2>
            </div>
            <div class="task-list-container" id="main-task-list"></div>
        </div>
    </div>

    <div id="sub-task-page" class="page sub-task-view">
        <div class="container">
            <div class="header">
                <button id="sub-task-back-btn">&larr;</button>
                <h3 id="sub-task-title">Task #1</h3>
            </div>
            <p>Complete all ads to get your reward.</p>
            <div class="sub-task-grid" id="sub-task-grid"></div>
        </div>
    </div>

    <div id="withdraw-page" class="page">
        <div class="container">
            <h2>Withdraw</h2>
            <div class="page-content">
                <p>Your current balance is sufficient for withdrawal.</p>
                <button id="withdraw-btn-page" class="withdraw-button">Withdraw Full Balance</button>
            </div>
        </div>
    </div>

    <div id="profile-page" class="page">
        <div class="container">
            <h2>My Profile</h2>
            <div class="page-content">
                <div class="info-group">
                    <label>Telegram Username</label>
                    <p id="profile-username">N/A</p>
                </div>
                <div class="info-group">
                    <label>Current Balance</label>
                    <p id="profile-balance">0.00</p>
                </div>
                <button id="logout-btn">Logout</button>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <button class="nav-button" data-page="home-page">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8h5z"></path></svg>
            <span>Home</span>
        </button>
        <button class="nav-button" data-page="withdraw-page">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4V6h16v12zM12 10c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"></path></svg>
            <span>Withdraw</span>
        </button>
        <button class="nav-button" data-page="profile-page">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
            <span>Profile</span>
        </button>
    </nav>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyBidXnyxl4LjnRW6z5PrQ_iOKzqjjrxRtM",
  authDomain: "comexaple.firebaseapp.com",
  projectId: "comexaple",
  storageBucket: "comexaple.firebasestorage.app",
  messagingSenderId: "799294329351",
  appId: "1:799294329351:web:0bb9620bc1d227a29650a2",
  measurementId: "G-LRBREF5QV6"
};
        const CONFIG = {
            mainTasksCount: 10,
            subTasksPerMainTask: 10,
            rewardPerMainTask: 1,
            allowedCountries: ['US', 'GB', 'CA'],
        };
        let APP_SETTINGS = {};

        // --- INITIALIZATION ---
        if (!firebaseConfig.apiKey) {
            alert("Firebase configuration is missing in index.html. The app will not work.");
        }
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let currentUser, userBalance = 0, userDocRef = null, userData = {};

        // --- CORE APP LOGIC ---
        window.addEventListener('load', async () => {
            showLoading("Initializing App...");
            try {
                await loadGlobalSettings();
                
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
                currentUser = Telegram.WebApp.initDataUnsafe?.user || { id: `testuser_${Date.now()}`, first_name: 'Guest', username: 'guestuser' };
                
                await loadUserData();
                setupEventListeners();
                navigateTo('home-page');
            } catch (error) {
                console.error("Initialization failed:", error);
                alert("App could not start. Please check your internet connection and try again.");
            } finally {
                hideLoading();
            }
        });

        // The rest of the javascript code is identical to the last one provided, ensuring all functionalities
        // like navigation, task generation, vpn check, and data handling work as intended.
        // It includes: loadGlobalSettings, loadUserData, setupEventListeners, navigateTo, updateAllUI,
        // checkVpnAndGoToMainTasks, generateMainTaskList, generateSubTaskList, performSubTask,
        // showExtraIncomeAd, requestWithdrawal, showLoading, hideLoading.
        
        // Helper functions
        function showLoading(text = "Loading...") {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('loading-overlay').style.display = 'flex';
        }
        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        async function loadGlobalSettings() {
            try {
                const doc = await db.collection('settings').doc('config').get();
                if (doc.exists) {
                    APP_SETTINGS = doc.data();
                    if (APP_SETTINGS.gigaPubId) {
                        const gigaScript = document.createElement('script');
                        gigaScript.src = `https://ad.gigapub.tech/script?id=${APP_SETTINGS.gigaPubId}`;
                        document.head.appendChild(gigaScript);
                    }
                    if (APP_SETTINGS.bannerUrl) {
                        const bannerImg = document.getElementById('cover-banner');
                        bannerImg.src = APP_SETTINGS.bannerUrl;
                        bannerImg.style.display = 'block';
                    }
                }
            } catch (e) { console.error("Failed to load app settings:", e); }
        }
        
        async function loadUserData() {
            if (!currentUser) return;
            userDocRef = db.collection('users').doc(currentUser.id.toString());
            const doc = await userDocRef.get();
            const today = new Date().toISOString().slice(0, 10);

            if (doc.exists) {
                userData = doc.data();
                if (userData.lastLoginDate !== today) {
                    userData.mainTasksCompleted = 0;
                    userData.subTasks = {};
                }
            } else {
                userData = { balance: 0, mainTasksCompleted: 0, subTasks: {} };
                await userDocRef.set({ ...userData, joinedAt: new Date(), username: currentUser.username });
            }
            userData.lastLoginDate = today;
            userBalance = userData.balance || 0;
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-button').forEach(b => b.addEventListener('click', () => navigateTo(b.dataset.page)));
            document.getElementById('start-task-btn').addEventListener('click', checkVpnAndGoToMainTasks);
            document.getElementById('extra-income-btn').addEventListener('click', showExtraIncomeAd);
            document.getElementById('main-task-back-btn').addEventListener('click', () => navigateTo('home-page'));
            document.getElementById('sub-task-back-btn').addEventListener('click', () => { generateMainTaskList(); navigateTo('main-task-page'); });
            document.getElementById('logout-btn').addEventListener('click', () => alert('Logout is not applicable in Telegram Mini Apps.'));
            document.getElementById('withdraw-btn-page').addEventListener('click', requestWithdrawal);
        }

        function navigateTo(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.toggle('active', b.dataset.page === pageId));
            updateAllUI();
        }

        function updateAllUI() {
            document.getElementById('home-balance').textContent = userBalance.toFixed(2);
            document.getElementById('profile-balance').textContent = userBalance.toFixed(2);
            document.getElementById('home-welcome-name').textContent = `Welcome, ${currentUser.first_name}!`;
            document.getElementById('profile-username').textContent = `@${currentUser.username || 'N/A'}`;
            document.getElementById('tasks-completed-summary').textContent = `${userData.mainTasksCompleted || 0}/${CONFIG.mainTasksCount}`;
        }

        async function checkVpnAndGoToMainTasks() {
            showLoading('Verifying Location...');
            try {
                const resp = await fetch('https://ipapi.co/json/');
                if (!resp.ok) throw new Error('Location service failed');
                const data = await resp.json();
                const countryCode = data.country_code;
                if (CONFIG.allowedCountries.includes(countryCode)) {
                    navigateTo('main-task-page');
                    generateMainTaskList();
                } else {
                    alert(`Access Denied. Please connect to a VPN in the US, UK, or Canada.`);
                }
            } catch (err) {
                alert('Could not verify your location. Please check your internet/VPN.');
            } finally {
                hideLoading();
            }
        }
        
        function generateMainTaskList() {
            const listEl = document.getElementById('main-task-list');
            listEl.innerHTML = '';
            for (let i = 1; i <= CONFIG.mainTasksCount; i++) {
                const isCompleted = i <= (userData.mainTasksCompleted || 0);
                const subTasksDone = userData.subTasks?.[`task_${i}`] || 0;
                const item = document.createElement('div');
                item.className = 'task-item';
                item.innerHTML = `
                    <div class="task-item-info">
                        <span>Task #${i}</span>
                        <p>${isCompleted ? 'Reward Claimed' : `${subTasksDone}/${CONFIG.subTasksPerMainTask} Ads Completed`}</p>
                        ${!isCompleted ? `<div class="sub-task-progress"><div style="width: ${subTasksDone / CONFIG.subTasksPerMainTask * 100}%"></div></div>` : ''}
                    </div>
                    <span class="status-icon">${isCompleted ? '✅' : '➡️'}</span>`;
                if (!isCompleted) item.addEventListener('click', () => generateSubTaskList(i));
                listEl.appendChild(item);
            }
        }

        function generateSubTaskList(mainTaskIndex) {
            navigateTo('sub-task-page');
            document.getElementById('sub-task-title').textContent = `Task #${mainTaskIndex}`;
            const gridEl = document.getElementById('sub-task-grid');
            gridEl.innerHTML = '';
            const subTasksDone = userData.subTasks?.[`task_${mainTaskIndex}`] || 0;
            
            for (let i = 1; i <= CONFIG.subTasksPerMainTask; i++) {
                const isCompleted = i <= subTasksDone;
                const item = document.createElement('button');
                item.className = `sub-task-item ${isCompleted ? 'completed' : ''}`;
                item.textContent = isCompleted ? '✓' : i;
                if (!isCompleted && i === subTasksDone + 1) {
                    item.addEventListener('click', () => performSubTask(mainTaskIndex, i));
                } else {
                    item.disabled = true;
                }
                gridEl.appendChild(item);
            }
        }

        async function performSubTask(mainTaskIndex, subTaskIndex) {
            if (typeof window.showGiga !== 'function') return alert('Ad service not ready.');
            showLoading('Loading Ad...');
            try {
                await window.showGiga();
                if (!userData.subTasks) userData.subTasks = {};
                userData.subTasks[`task_${mainTaskIndex}`] = subTaskIndex;

                if (subTaskIndex === CONFIG.subTasksPerMainTask) {
                    userData.mainTasksCompleted = (userData.mainTasksCompleted || 0) + 1;
                    userBalance += CONFIG.rewardPerMainTask;
                    alert(`Congratulations! Task #${mainTaskIndex} completed.`);
                }
                await userDocRef.set({ ...userData, balance: userBalance }, { merge: true });
                if (subTaskIndex === CONFIG.subTasksPerMainTask) {
                    generateMainTaskList();
                    navigateTo('main-task-page');
                } else {
                    generateSubTaskList(mainTaskIndex);
                }
            } catch (e) {
                alert('Ad failed to load. Please try again.');
            } finally {
                hideLoading();
            }
        }
        
        function showExtraIncomeAd() {
            if (APP_SETTINGS.adsterraCode) {
                alert(`Placeholder for Adsterra Ads. Code/ID: ${APP_SETTINGS.adsterraCode}`);
            } else {
                alert('Extra income option is not available.');
            }
        }
        
        async function requestWithdrawal() {
            if (userBalance <= 0) return alert('Insufficient balance.');
            showLoading('Submitting request...');
            try {
                await db.collection('withdrawals').add({
                    userId: currentUser.id.toString(), username: currentUser.username,
                    amount: userBalance, requestedAt: new Date(), status: 'pending'
                });
                userBalance = 0;
                await userDocRef.update({ balance: 0 });
                updateAllUI();
                alert('Withdrawal request sent!');
            } catch(e) {
                alert('Failed to send request.');
            } finally {
                hideLoading();
            }
        }
    </script>
</body>
</html>
